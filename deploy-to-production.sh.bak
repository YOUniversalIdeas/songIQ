#!/bin/bash

# songIQ Production Deployment Script
# This script automates the production deployment process

set -e

echo "üöÄ songIQ Production Deployment"
echo "==============================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}[‚úì]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[‚ö†]${NC} $1"
}

print_error() {
    echo -e "${RED}[‚úó]${NC} $1"
}

print_header() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Configuration
STAGING_SERVER="64.202.184.174"
PRODUCTION_DOMAIN="songiq.com"

print_header "Pre-Deployment Checklist"
echo ""

# Check if we're on the right branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "staging" ]; then
    print_warning "You're on branch: $CURRENT_BRANCH"
    print_warning "Consider switching to 'main' or 'staging' branch"
    read -p "Continue anyway? (y/N): " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check if there are uncommitted changes
if ! git diff-index --quiet HEAD --; then
    print_warning "You have uncommitted changes"
    git status --short
    read -p "Continue anyway? (y/N): " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

print_status "Pre-deployment checks passed"

print_header "Step 1: Build Applications"
echo ""

# Build client
print_header "Building client application..."
cd songiq/client
npm run build
print_status "Client build completed"

# Build server
print_header "Building server application..."
cd ../server
npm run build
print_status "Server build completed"

cd ../..

print_header "Step 2: Prepare Deployment Package"
echo ""

# Create deployment directory
DEPLOY_DIR="deploy-package-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$DEPLOY_DIR"

# Copy built applications
cp -r songiq/client/dist "$DEPLOY_DIR/client"
cp -r songiq/server/dist "$DEPLOY_DIR/server"

# Copy environment files
cp songiq/server/env.production "$DEPLOY_DIR/server.env"
cp songiq/client/env.production "$DEPLOY_DIR/client.env"

# Copy PM2 configuration
cp ecosystem.config.js "$DEPLOY_DIR/"

# Copy setup scripts
cp setup-database.sh "$DEPLOY_DIR/"
cp setup-api-keys.sh "$DEPLOY_DIR/"

print_status "Deployment package created: $DEPLOY_DIR"

print_header "Step 3: Upload to Staging Server"
echo ""

# Upload deployment package
print_header "Uploading files to staging server..."
scp -r "$DEPLOY_DIR" root@$STAGING_SERVER:/tmp/
print_status "Files uploaded successfully"

print_header "Step 4: Deploy on Staging Server"
echo ""

# Deploy on staging server
ssh root@$STAGING_SERVER << EOF
echo "=== Deploying songIQ to Production ==="
echo ""

# Navigate to deployment directory
cd /tmp/$DEPLOY_DIR

# Stop existing services
pm2 stop all 2>/dev/null || true

# Backup current deployment
if [ -d "/var/www/songiq-staging" ]; then
    echo "Backing up current deployment..."
    tar -czf /var/backups/songiq-backup-\$(date +%Y%m%d-%H%M%S).tar.gz -C /var/www songiq-staging
fi

# Create application directory
mkdir -p /var/www/songiq-staging

# Copy new files
cp -r client /var/www/songiq-staging/
cp -r server /var/www/songiq-staging/
cp ecosystem.config.js /var/www/songiq-staging/

# Copy environment files
cp server.env /var/www/songiq-staging/server/.env
cp client.env /var/www/songiq-staging/client/.env

# Set permissions
chown -R root:root /var/www/songiq-staging
chmod -R 755 /var/www/songiq-staging

# Create logs directory
mkdir -p /var/www/songiq-staging/logs

echo "Deployment files copied successfully"
echo ""

# Run database setup if needed
if [ ! -f "/var/www/songiq-staging/.database-setup-complete" ]; then
    echo "Setting up database..."
    chmod +x setup-database.sh
    ./setup-database.sh
    touch /var/www/songiq-staging/.database-setup-complete
    echo "Database setup completed"
else
    echo "Database already set up, skipping..."
fi

# Start services
echo "Starting services..."
cd /var/www/songiq-staging
pm2 start ecosystem.config.js --env production
pm2 save

echo "Services started successfully"
echo ""

# Check service status
echo "=== Service Status ==="
pm2 status
echo ""

# Test endpoints
echo "=== Testing Endpoints ==="
echo "Testing health endpoint..."
curl -s http://localhost:5000/api/health || echo "Health check failed"
echo ""

echo "Testing songs endpoint..."
curl -s http://localhost:5000/api/songs || echo "Songs endpoint failed"
echo ""

echo "=== Deployment Complete ==="
echo "Application deployed successfully!"
echo "Frontend: http://$STAGING_SERVER:4173/"
echo "API: http://$STAGING_SERVER:5000/api/health"
echo ""
echo "Next steps:"
echo "1. Update DNS to point $PRODUCTION_DOMAIN to $STAGING_SERVER"
echo "2. Install SSL certificate"
echo "3. Configure Nginx reverse proxy"
echo "4. Test production domain"
EOF

print_status "Deployment completed on staging server"

print_header "Step 5: Post-Deployment Verification"
echo ""

# Test staging endpoints
print_header "Testing staging endpoints..."

if curl -s "http://$STAGING_SERVER:5000/api/health" > /dev/null; then
    print_status "API health check passed"
else
    print_error "API health check failed"
fi

if curl -s "http://$STAGING_SERVER:4173/" > /dev/null; then
    print_status "Frontend accessible"
else
    print_error "Frontend not accessible"
fi

print_header "Step 6: Next Steps"
echo ""

echo "üéØ Manual Steps Required:"
echo "========================"
echo ""
echo "1. üåê DNS Configuration:"
echo "   - Update DNS to point $PRODUCTION_DOMAIN to $STAGING_SERVER"
echo "   - Wait for DNS propagation (1-48 hours)"
echo ""
echo "2. üîí SSL Certificate:"
echo "   - SSH into server: ssh root@$STAGING_SERVER"
echo "   - Install Nginx: yum install -y nginx"
echo "   - Install Certbot: yum install -y certbot python3-certbot-nginx"
echo "   - Get SSL certificate: certbot --nginx -d $PRODUCTION_DOMAIN -d www.$PRODUCTION_DOMAIN"
echo ""
echo "3. ‚öôÔ∏è Nginx Configuration:"
echo "   - Configure reverse proxy (see PRODUCTION_DEPLOYMENT_COMPLETE.md)"
echo "   - Test configuration: nginx -t"
echo "   - Reload Nginx: systemctl reload nginx"
echo ""
echo "4. üîë API Keys:"
echo "   - Configure Spotify, Last.fm, Stripe API keys"
echo "   - Update /var/www/songiq-staging/server/.env"
echo "   - Restart services: pm2 restart all"
echo ""

print_header "Deployment Summary"
echo "====================="
echo ""
echo "‚úÖ Applications built successfully"
echo "‚úÖ Files uploaded to staging server"
echo "‚úÖ Services started"
echo "‚úÖ Database configured"
echo "‚úÖ Basic testing completed"
echo ""
echo "üåê Staging URLs:"
echo "Frontend: http://$STAGING_SERVER:4173/"
echo "API: http://$STAGING_SERVER:5000/api/health"
echo ""
echo "üìö Documentation:"
echo "Complete guide: PRODUCTION_DEPLOYMENT_COMPLETE.md"
echo "API keys setup: API_KEYS_SETUP_GUIDE.md"
echo "Database setup: DATABASE_SETUP_GUIDE.md"
echo ""

print_warning "Remember to update DNS and configure SSL for production access!"
echo ""

print_status "Deployment script completed! üéâ"

# Cleanup
rm -rf "$DEPLOY_DIR"
print_status "Temporary files cleaned up"
